#!/bin/bash -l

%includeonce <ecflow_bash.h>
%includeonce <sim.h>
%includeonce <const.h>
%includeonce <geff.h>
%includeonce <scripts.h>


%includeonce <cdo.h>
%includeonce <nco.h>


mars << EOF
    retrieve,
        source="${sim_grib_prefix}228.128",
        $sim_mars_stream,
        $sim_mars_type,
        $sim_mars_prev_date,
        $sim_mars_prev_day_steps,
        $sim_mars_expver,
        levtype=sfc,
        class=od,
        param=228.128,
        fieldset=dm1
    retrieve,
        step=$sim_prev_24h_last_step,
        fieldset=dm1_24
    retrieve,
        source="${sim_grib_prefix}228.128",
        ${sim_mars_date},
        ${sim_mars_first_day_steps},
        fieldset=d
    compute,
        fieldset=dm1_24_new,
        formula="repeat(dm1_24,7)"
    compute,
        fieldset=daily,
        formula = "d + dm1_24_new - dm1"
    write,
        fieldset=daily,
        target="pr.tmp"
    write,
        fieldset=dm1_24,
        target="pr.tmp"
    retrieve,
        $sim_mars_date,
        step=3/to/144/by/24,
        fieldset=a_3
    retrieve,
        $sim_mars_date,
        step=6/to/240/by/24,
        fieldset=a_6
    retrieve,
        $sim_mars_date,
        step=9/to/144/by/24,
        fieldset=a_9
    retrieve,
        $sim_mars_date,
        step=12/to/240/by/24,
        fieldset=a_12
    retrieve,
        $sim_mars_date,
        step=15/to/144/by/24,
        fieldset=a_15
    retrieve,
        $sim_mars_date,
        step=18/to/240/by/24,
        fieldset=a_18
    retrieve,
        $sim_mars_date,
        step=21/to/144/by/24,
        fieldset=a_21
    retrieve,
        $sim_mars_date,
        step=0/to/240/by/24,
        fieldset=a_24
    compute,
        formula     = "a_3[2,count(a_3)]-a_3[1,count(a_3)-1]",
        fieldset    = a3_all
    write,
        fieldset=a3_all,
        target="pr.tmp"
    compute,
        formula     = "a_6[2,count(a_6)]-a_6[1,count(a_6)-1]",
        fieldset    = a6_all
    write,
        fieldset=a6_all,
        target="pr.tmp"
    compute,
        formula     = "a_9[2,count(a_9)]-a_9[1,count(a_9)-1]",
        fieldset    = a9_all
    write,
        fieldset=a9_all,
        target="pr.tmp"
    compute,
        formula     = "a_12[2,count(a_12)]-a_12[1,count(a_12)-1]",
        fieldset    = a12_all
    write,
        fieldset=a12_all,
        target="pr.tmp"
    compute,
        formula     = "a_15[2,count(a_15)]-a_15[1,count(a_15)-1]",
        fieldset    = a15_all
    write,
        fieldset=a15_all,
        target="pr.tmp"
    compute,
        formula     = "a_18[2,count(a_18)]-a_18[1,count(a_18)-1]",
        fieldset    = a18_all
    write,
        fieldset=a18_all,
        target="pr.tmp"
    compute,
        formula     = "a_21[2,count(a_21)]-a_21[1,count(a_21)-1]",
        fieldset    = a21_all
    write,
        fieldset=a21_all,
        target="pr.tmp"
    compute,
        formula     = "a_24[2,count(a_24)]-a_24[1,count(a_24)-1]",
        fieldset    = a24_all
    write,
        fieldset=a24_all,
        target="pr.tmp"
    retrieve,
        $sim_mars_date,
        step=0/3/6/9/12/15/18/21/24/27/30/33/36/39/42/45/48/51/54/57/60/63/66/69/72/75/78/81/84/87/90/93/96/99/102/105/108/111/114/117/120/123/126/129/132/135/138/141/144/150/156/162/168/174/180/186/192/198/204/210/216/222/228/234/240,
        fieldset=tp_accumulated
    compute,
        fieldset=tp_decumulated,
        formula="tp_accumulated [2,count(tp_accumulated)]-tp_accumulated[1,count(tp_accumulated)-1]"
    write,
       fieldset=tp_decumulated,
       target= "prdur.tmp"
EOF


grib_copy -B "date:l asc, step:l asc" pr.tmp pr.grb
grib_copy -B "date:l asc, step:l asc" prdur.tmp prdur.grb

lz4get $const_dir/remapcon.nc.lz4 remapcon.nc


for day in $sim_days; do
    ymd=$(newdate -D $sim_ymd +$day)
    # assemble 12 UTC local time field
    metview -b $scripts_dir/field_at_solar_time $ymd 12 pr.grb tmp.grb
    # interpolate to regular grid in netcdf format
    # mask data over water
    # TODO: FAILS, there is no "mask.nc"
    #cdo -R -f nc -remapcon,n$sim_resol -setrtoc,-100,0,0 \
    #    -mulc,1000 -setname,tp -settime,12:00:00 tmp.grb tmp.nc
    #cdo ifthen $static_dir/mask.nc tmp.nc pr.$day.nc
    # TODO: temporary code to avoid the above problems
    cdo -R -f nc -remap,n$sim_resol,remapcon.nc -setrtoc,-100,0,0 \
        -mulc,1000 -setname,tp -settime,12:00:00 tmp.grb pr.$day.nc
done
cdo mergetime pr.*.nc pr.nc
cdo infov pr.nc

# interpolate to regular grid in netcdf format
#cdo -R -f nc -remapcon,n$sim_resol -settime,12:00:00 \
#    -daysum -mulc,$dt -setrtoc2,-1,0.001,0,1 \
#    -shifttime,-1hour -setname,dp prdur.grb _prdur1.nc
# TODO: mask.nc does not exist
# mask data over water
#cdo ifthen $static_dir/mask.nc _prdur1.nc _prdur2.nc

# TODO: below is temporary
date_middle=$(newdate -D $sim_ymd +6)
cdo seldate,$sim_ymd,$date_middle prdur.grb tmp1.grb
dt=3
cdo -R -f nc -remap,n$sim_resol,remapcon.nc -settime,12:00:00 \
    -daysum -mulc,$dt -setrtoc2,-1,0.001,0,1 \
    -shifttime,-1hour -setname,dp tmp1.grb tmp1.nc

date_end=$(newdate -D $sim_ymd +$sim_numdays)
cdo seldate,$date_middle,$date_end prdur.grb tmp2.grb
dt=6
cdo -R -f nc -remap,n$sim_resol,remapcon.nc -settime,12:00:00 \
    -daysum -mulc,$dt -setrtoc2,-1,0.001,0,1 \
    -shifttime,-1hour -setname,dp tmp2.grb tmp2.nc

cdo mergetime tmp1.nc tmp2.nc _prdur2.nc

# check: if cumulated precipitation is less
# than 1 then duration of precipitation = 0
cdo -gtc,1 pr.nc _mask_prec.nc
cdo -mul -setname,dp _mask_prec.nc _prdur2.nc prdur.nc

# add GEFF version to the metadata
ncatted -O -a version,global,c,c,"$geff_version" pr.nc
ncatted -O -a version,global,c,c,"$geff_version" prdur.nc

rm -f _*

mkdir -p $sim_dir

pids=''
for v in pr prdur; do
  gzip -c $v.nc > $sim_dir/$v.nc.gz &
  pids="$pids $!"
done
wait $pids
